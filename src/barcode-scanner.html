
<link rel="import" href="../bower_components/polymer/polymer.html">


<!--
`<barcode-scanner>` is an element to render a QR Code

Typical usage:

```html
  <barcode-scanner active="[[active]]"></barcode-scanner>
```

@element barcode-scanner
@blurb An element to scan a QR Code
@homepage index.html
@demo demo/index.html
-->

<!--<script src="../jsqrcode/dist/jsqrcode.js"></script>
<script src="../quagga/dist/quagga.min.js"></script>-->

<script src="../bower_components/quagga/dist/quagga.js"></script>

<dom-module is="barcode-scanner">

    <template>
        <style>
            :host {
                display: block;
            }
            video {
                position: relative;
                width: 320px;
                height: 240px;
                border-radius: 10px;
                display: flex;
                /*top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);*/
            }
            .drawingBuffer {
                display: none
            }
            [hide] {
                display: none !important;
            }
            .media {
                display: flex;
                flex-flow: column nowrap;
                align-items: center;
            }
            .placeholder {
                width: var(--placeholder-width, 320px);
                height: var(--placeholder-height, 240px);
                border-radius: 10px;
                background-color:var(--placeholder-background-color, #ffc107);
                color: var(--placeholder-color, white);
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                font-size: 24px;
                font-weight: bold;
            }
            svg {
                max-width: 30vw;
                max-height: 30vw;
            }
            .videoContainer{
                position: relative;
            }
            .pictureControls{
                position: absolute;
                bottom: 5px;
                width: 100%;
                fill: #ffc107;
                opacity: 0.5;
                display: flex;
                flex-flow: row;
                justify-content: center;
            }
        </style>
        <div class="media">
            <template is="dom-if" if="[[!active]]">
                <div class="placeholder"  on-tap="_activate">[[placeholderMessage]]</div>
            </template>
            <!--<canvas id="qrCanvasDisplay" width="[[width]]" height="[[height]]" hide$="[[!active]]" on-tap="_deactivate"></canvas>-->
            <div id="interactive" class="viewport" on-tap="_deactivate"></div>
            <template  is="dom-if" if="[[active]]">

            </template>

        </div>
    </template>

    <script>
        Polymer({
            is: "barcode-scanner",

            properties: {
                result: {
                    type: Object,
                    notify: true,
                    readOnly: true,
                    value: null
                },
                code: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    readOnly: true,
                    value: ''
                },
                active: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                },
                /**
                 * If true the elements scans for QR code
                 */


                /**
                 * The last decoded QRCode
                 */
                data: {
                    type: String,
                    notify: true,
                    value: "",
                },
                /**
                 * The width of the scanning window
                 */
                width: {
                    type: Number,
                    value: 320
                },
                /**
                 * The height of the scanning window
                 */
                height: {
                    type: Number,
                    value: 240
                },
                /**
                 * The message to show when scanner isn't activated
                 */
                placeholderMessage: {
                    type: String,
                    value: "Tap here to activate scanner",
                } ,

            },

            attached: function() {

                Quagga.onDetected(function(res){
                    elem.data = res.codeResult.code;
                    console.debug("[barcode-scanner] Quagga.onDetected", elem.data, elem);
                    elem.fire("qrcode-decoded", res);
                });
            },

            _activate: function() {
                this._isReady = false;
                var _this = this;
                _this.active = true;

                Quagga.init({
                    inputStream : {
                        name : "Live",
                        type : "LiveStream",
                        target: _this.$.interactive
                    },
                    decoder : {
                        readers : ["code_128_reader"]
                    }
                }, function(err) {
                    _this.querySelector('video').className += ' barcode-scanner';

                    if (err) {
                        console.log(err);
                        return;
                    }

                    Quagga.start();
                });
            },
            _deactivate: function() {
                this.active = false;
                Quagga.stop();
            },

        });
    </script>

</dom-module>
