<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-time-input/paper-time-input.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="dhl-icons.html">

<dom-module id="dhl-tripdetails">
    <template>
        <style include="iron-flex iron-flex-alignment iron-positioning"></style>
        <style include="shared-styles">
            :host {
                display: block;
                @apply(--paper-font-common-base);
            }

            paper-button {
                height: 60px;
                margin-bottom: 5px;
            }
            .item {
                outline: none;
                cursor: pointer;
            }

            .timeframe {
                font-size: 18px;
                font-weight: bold;
            }
            .status {
                font-size: 16px;
                font-weight: bold;
                margin-left: 20px;
            }

            .tripnum{
                font-size: 16px;
            }

            .longText {
                font-size: 16px;
                display: none;
            }

            .item.expanded .longText {
                display: block;
            }

            .details{
                margin-bottom: 40px;
            }

            .leading {
                width: 30px;
            }

        </style>

        <dhl-xmlxhr
                id="ajax300"
                url="/src/xml/301.xml"
                method="GET"
                body="[[req300]]"
                response="{{resp301}}"
                ok-text="Opdrachten Opgehaald"
                error-text="Opdrachten Ophalen Mislukt">
        </dhl-xmlxhr>

        <dhl-xmlxhr
                id="ajax200"
                url="/src/xml/201B.xml"
                method="GET"
                body="[[req200]]"
                response="{{resp201}}"
                ok-text="Ritten Opgehaald"
                error-text="Ritten Ophalen Mislukt">
        </dhl-xmlxhr>

        <dhl-xmlxhr
                id="ajax2000"
                url="/src/xml/2001.xml"
                method="GET"
                body="[[req2000]]"
                response="{{resp2001}}"
                ok-text="Rit Gestart"
                error-text="Rit Starten Mislukt">
        </dhl-xmlxhr>

        <div class="timeframe">[[computeTimeFrameDesc()]]</div> <!--[[timeframe.TIMEFRAME_DESCRIPTION]]-->
        <div class="layout horizontal">
            <div class="leading">[[calculateSeq(trip)]]</div>
            <!--<div class="leading">[[trip.TRIP_SEQUENCE_NUMBER]]</div>-->
            <div class="details">
                <div class="layout horizontal">
                    <div>Rit [[trip.TRIP_NUMBER]]</div>
                    <div class="status">[[trip.TRIP_PDA_STATUS_DESCRIPTION]]</div>
                    <div class="flex"></div>
                    <div>0/[[trip.NUMBER_IN_TRIP]]</div>
                </div>


                <div hide$="[[!compareValues(2,trip.TRIP_PDA_STATUS)]]">
                    <div class="layout horizontal">
                        <paper-time-input
                                id="evaInput"
                                label="Eerste Verwachte Aankomst"
                                value="{{evaValue}}"
                                format="24"
                                on-change="onChangeEva"
                                required
                                auto-validate></paper-time-input>
                    </div>
                    <div class="layout horizontal">
                        <paper-button
                                on-tap="onEVATap"
                                trip="[[trip]]"
                                raised
                                disabled$="{{evaInvalid}}">EVA Verzenden</paper-button>
                    </div>
                </div>


                <div hide$="[[!compareValues(3,trip.TRIP_PDA_STATUS)]]">
                    <div class="layout horizontal">
                        <paper-input
                                label="Start km"
                                value="startKmValue"
                                type="number"
                                on-change="onChangeStartKm"
                                required
                                auto-validate>km</paper-input>
                        <paper-input
                                label="Eind km"
                                value="endKmValue"
                                type="number"
                                on-change="onChangeEndKm"
                                required
                                auto-validate></paper-input>
                        <paper-input
                                label="Prive km"
                                value="privateValue"
                                type="number"
                                on-change="onChangePrivate"
                                required
                                auto-validate></paper-input>
                    </div>
                    <div class="layout horizontal">
                        <paper-button
                                on-tap="onStartTap"
                                trip="[[trip]]"
                                raised
                                disabled$="{{startKmInvalid}}">
                            <iron-icon icon="dhl-icons:starttrip"></iron-icon> Start Rit</paper-button>
                        <paper-button
                                on-tap="onStartTap"
                                trip="[[trip]]"
                                raised
                                disabled
                                disabled$="{{endKmInvalid}}">
                            <iron-icon icon="dhl-icons:endtrip"></iron-icon> Einde Rit</paper-button>
                    </div>
                </div>
            </div>
        </div>


        <a id="startNav" href="/tripexecute" style="display:none;">Start Rit</a>

    </template>

    <script>

        Polymer({
            is: 'dhl-tripdetails',

            properties: {

                /**
                 * The GENERAL_HEADER_PDA object tripParcels
                 */
                generalHeaderPda:{
                    type: Object,
                    notify: true
                },

                /**
                 * The current trip object
                 */
                trip:{
                    type: Object,
                },

                /**
                 * The Array of parcels filtered by selected trip_key
                 */
                tripParcels:{
                    type: Array,
                    value: function(){
                        return [];
                    },
                    notify: true
                },

                /**
                 * The TripsOverview object sent to the server
                 */
                req200:{
                    type: Object,
                    value: function(){
                        return {
                            Envelope:{
                                Header: null,
                                Body: {
                                    TripsOverview: {
                                        GENERAL_HEADER_PDA:{},
                                    }
                                }
                            }
                        }
                    }
                },

                /**
                 * The resp201 object returned from the server
                 */
                resp201:{
                    type: Object,
                    observer: 'resp201Changed',
                    notify: true
                },

                /**
                 * The ParcelsInTrip object sent to the server
                 */
                req300:{
                    type: Object,
                    value: function(){
                        return {
                            Envelope:{
                                Header: null,
                                Body: {
                                    ParcelsInTrip: {
                                        GENERAL_HEADER_PDA:{},
                                        PDA_DATA_INDICATION: true
                                    }
                                }
                            }
                        }
                    }
                },

                /**
                 * The resp301 object returned from the server
                 */
                resp301:{
                    type: Object,
                    observer: 'resp301Changed',
                    notify: true
                },

                /**
                 * The BeginAndEndMilageTrip object sent to the server
                 */
                req2000:{
                    type: Object,
                    value: function(){
                        return {
                            Envelope:{
                                Header: null,
                                Body: {
                                    BeginAndEndMilageTrip: {
                                        GENERAL_HEADER_PDA:{},
                                        BEGIN_END_TRIP_MILEAGE: {}
                                    }
                                }
                            }
                        }
                    }
                },

                /**
                 * The BeginAndEndMilageTrip object returned from the server
                 */
                resp2001:{
                    type: Object,
                    observer: 'resp2001Changed',
                    notify: true
                },

                /**
                 * The select trip id that results from this process
                 */
                selectedTripId:{
                    type: Object,
                    notify: true
                },

                evaInvalid:{
                    type: Boolean,
                    value: true
                },

                startKmInvalid:{
                    type: Boolean,
                    value: true
                },

                endKmInvalid:{
                    type: Boolean,
                    value: true
                }

            },

            computeTimeFrameDesc: function(){
                if(!this.trip) return '';
                var timeframeKey = this.trip.TIMEFRAME_KEY;
                var timeFrame = this.resp201['xml-fragment'].REPLY_OVERVIEW_TIMEFRAME.find(function(tf){
                    return (timeframeKey.toString() == tf.TIMEFRAME_KEY.toString());
                }.bind(this));
                return timeFrame.TIMEFRAME_DESCRIPTION;
            },

            calculateSeq: function(trip) {
                return 1;
                return parseInt(trip.TRIP_SEQUENCE_NUMBER) + 1;
            },

            onChangeEva: function(e){
                if(e.target.validate()) this.evaInvalid = false;
                else this.evaInvalid = true;
            },

            onChangeStartKm: function(e){
                if(e.target.validate()) this.startKmInvalid = false;
                else this.startKmInvalid = true;
            },

            onChangeEndKm: function(e){
                if(e.target.validate()) this.evaInvalid = false;
                else this.evaInvalid = true;
            },

            onChangePrivateKm: function(e){
                if(e.target.validate()) this.evaInvalid = false;
                else this.evaInvalid = true;
            },




            getClassForItem: function(item, selected) {
                return selected ? 'item expanded' : 'item';
            },

            compare: function(val1, val2) {
                return val1 == val2;
            },

            computedIndex: function(index) {
                return index+1;
            },

            /*
             // send EVA, get parcels
            */
            onEVATap: function(event) {

                // set the timestamp
                var evaValue = this.$.evaInput;
                var ts = new Date();
                ts.setHours(evaValue.hour);
                ts.setMinutes(evaValue.min);
                ts.setSeconds(0);

                // find timeframe in resp201
                var timeframeKey = this.trip.TIMEFRAME_KEY;
                var timeFrameIdx = this.resp201['xml-fragment'].REPLY_OVERVIEW_TIMEFRAME.findIndex(function(tf){
                    return (timeframeKey.toString() == tf.TIMEFRAME_KEY.toString());
                }.bind(this));

                var TIMEFRAME = {
                    TIMEFRAME_KEY: timeframeKey,
                    EXPECTED_ARRIVAL_TIME_FIRST_ADDRESS: ts.toJSON().toString()
                };

                // add/update timeframe to request
                if(timeFrameIdx > -1) this.req300.Envelope.Body.ParcelsInTrip[timeFrameIdx] = TIMEFRAME;
                else this.req300.Envelope.Body.ParcelsInTrip.push(TIMEFRAME);

                // customize the general header
                this.generalHeaderPda.MESSAGE_IDENTIFIER = 300;
                this.generalHeaderPda.MESSAGE_IDENTIFIER = new Date().toJSON().toString();
                this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER =
                        parseInt(this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER) + 1;

                // send start trip request
                this.req300.Envelope.Body.ParcelsInTrip.GENERAL_HEADER_PDA = this.generalHeaderPda;

                this.$.ajax300.generateRequest();
            },

            /*
             // request trips (this will update EVA in display)
             */
            resp301Changed: function(resp, oldValue) {
                if(!resp) return;

                // populate our tripParcel array
                this.tripParcels = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS.filter(function(parcel){
                    return parcel.TRIP_KEY.toString() == this.trip.TRIP_KEY.toString();
                }.bind(this));

                // customize the general header
                this.generalHeaderPda.MESSAGE_IDENTIFIER = 200;
                this.generalHeaderPda.MESSAGE_IDENTIFIER = new Date().toJSON().toString();
                this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER =
                        parseInt(this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER) + 1;

                this.req200.Envelope.Body.TripsOverview.GENERAL_HEADER_PDA = this.generalHeaderPda;

                this.$.ajax200.generateRequest();
            },

            resp201Changed: function(resp, oldValue) {
                if(!resp) return;
            },

            onStartTap: function(event) {

                this.req2000.Envelope.Body.BeginAndEndMilageTrip.BEGIN_END_TRIP_MILEAGE = {
                    TIMEFRAME_KEY: this.trip.TIMEFRAME_KEY,
                    TRIP_KEY: this.trip.TRIP_KEY,
                    TRIP_NUMBER: this.trip.TRIP_NUMBER,
                    TRIP_SEQUENCE_NUMBER: this.trip.TRIP_SEQUENCE_NUMBER,
                    BEGIN_TRIP_MILEAGE: this.startKmValue
                };

                // customize the general header
                this.generalHeaderPda.MESSAGE_IDENTIFIER = 2000;
                this.generalHeaderPda.MESSAGE_IDENTIFIER = new Date().toJSON().toString();
                this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER =
                        parseInt(this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER) + 1;

                // send start trip request
                this.req2000.Envelope.Body.BeginAndEndMilageTrip.GENERAL_HEADER_PDA = this.generalHeaderPda;

                this.$.ajax2000.generateRequest();

            },


            resp2001Changed: function(resp, oldValue) {
                if(!resp) return;
                this.$.startNav.click();
            },

            compareValues: function(v1, v2){
              return v1 == v2;
            },

            onEndTap: function(event) {
                this.trip = event.target.trip;
                //send request to the server

            },

        });

    </script>
</dom-module>

