<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="redux-store.html">
<link rel="import" href="barcode-scanner.html">
<link rel="import" href="shared-styles.html">

<dom-module id="dhl-tripexecute">
    <template>
        <style include="iron-flex iron-flex-alignment iron-positioning"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }

            .details{
                margin-bottom: 20px;
                border: #cc0201;
                border-style: solid;
                padding: 3px;
                cursor: pointer;
            }
            .details.selected {
                background-color: #fff;
            }
            .leading {
                width: 50px;
            }
        </style>

        <array-selector id="selector" items="{{tripParcels}}" selected="{{selected}}" toggle></array-selector>

        <div class="media">

            <barcode-scanner code="{{barcode}}"
                             placeholder-message="Scanner Activeren"
                             on-recognize="onRecognize">
            </barcode-scanner>

            <div class="card">
                <paper-input value="{{barcode}}"
                             label="PID"
                             required
                             auto-validate>
                </paper-input>

                <h3>Niet afgehandelde opdrachten</h3>
                <template is="dom-repeat"
                          id="itemsList"
                          items="{{tripParcels}}"
                          selected="{{selected}}"
                          as="parcel"
                          sort="sortBySeqNum"
                          observe="DELIVERY_SEQUENCE_NUMBER"
                          scroll-target="document">
                    <div class$="[[_computedClass(selected)]]" on-tap="toggleSelection">
                        <div class="layout horizontal">
                            <div class="leading">
                                <div class="layout vertical">
                                    <div>[[parcel.DELIVERY_SEQUENCE_NUMBER]]</div>
                                    <div>[[computeDelMom(parcel)]]</div>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="layout vertical">
                                    <!-- [[parcel.HOUSE_NUMBER_ADDITION]]-->
                                    <div>[[parcel.STREET]] [[parcel.HOUSE_NUMBER]]</div>
                                    <div>[[parcel.POSTAL_CODE_NUMERIC]][[parcel.POSTAL_CODE_ALPHA]] [[parcel.CITY]]</div>
                                    <div>[[parcel.CUSTOMER_SHORT_NAME]]</div>
                                </div>
                            </div>
                            <div class="layout vertical">
                                <div>PA</div>
                                <div>Icon</div>
                                <div>[[computeBarShort(parcel)]]</div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>


        <div class="media">

            <div class="card">
                <paper-input value="{{barcode}}"
                             label="PID"
                             required
                             auto-validate>
                </paper-input>

                <h3>Niet afgehandelde opdrachten</h3>
                <iron-list items="{{tripParcels}}"
                           as="parcel"
                           sort="sortBySeqNum"
                           selected-item="{{selectedParcel}}"
                           selection-enabled
                           scroll-target="document">
                    <template>
                        <div>
                            <div class$="[[_computedClass(selected)]]">
                                <div class="layout horizontal">
                                    <div class="leading">
                                        <div class="layout vertical">
                                            <div>[[parcel.DELIVERY_SEQUENCE_NUMBER]]</div>
                                            <div>[[computeDelMom(parcel)]]</div>
                                        </div>
                                    </div>
                                    <div class="flex">
                                        <div class="layout vertical">
                                            <!-- [[parcel.HOUSE_NUMBER_ADDITION]]-->
                                            <div>[[parcel.STREET]] [[parcel.HOUSE_NUMBER]]</div>
                                            <div>[[parcel.POSTAL_CODE_NUMERIC]][[parcel.POSTAL_CODE_ALPHA]] [[parcel.CITY]]</div>
                                            <div>[[parcel.CUSTOMER_SHORT_NAME]]</div>
                                        </div>
                                    </div>
                                    <div class="layout vertical">
                                        <div>PA</div>
                                        <div>Icon</div>
                                        <div>[[computeBarShort(parcel)]]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </iron-list>

            </div>
        </div>

        <audio id="audio" src="../images/censor-beep-01.mp3"></audio>
        <a id="parcelNav" href="/delivery" style="display:none;">In Rit</a>

    </template>

    <script>

        Polymer({
            is: 'dhl-tripexecute',

            behaviors: [ ReduxBehavior ],

            properties: {

                barcode:{
                    type: String,
                    observer: 'processBarcode',
                },

                selectedParcel:{
                    type: Object,
                    notify: true,
                    observer: 'selectedParcelChanged',
                },

                tripParcels:{
                    type: Array,
                    value: function(){return [];},
                    statePath: 'tripParcels',
                    observer: 'tripParcelsChanged'
                }
            },

            processBarcode: function(barcode, oldValue) {
                if(!barcode) return;
                //beep
                this.$.audio.play();

                //update the status in tripInfo
                //this.set('tripInfo.stops.'+sIdx+'.pieces.'+pIdx+'.status', 'sending...');

                this.$.parcelNav.click();
            },

            sortBySeqNum: function(v1, v2) {
                var val1 = parseInt(v1.DELIVERY_SEQUENCE_NUMBER), val2 = parseInt(v2.DELIVERY_SEQUENCE_NUMBER);
                if (val1 == val2) return 0;
                if (val1 > val2) return 1;
                if (val1 < val2) return -1;
            },

            _computedClass: function(isSelected) {
                var classes = 'details';
                if (isSelected) {
                    classes += ' selected';
                }
                return classes;
            },

            selectedParcelChanged: function(newValue){
                if(!newValue) return;
                this.$.parcelNav.click();
            },

            computeDelMom: function(parcel){
                if(!parcel.DELIVERY_MOMENT) return '';
                var ts = new Date(parcel.DELIVERY_MOMENT);
                return ts.getHours()+':'+ts.getMinutes();
            },

            computeBarShort: function(parcel){
                return '...'+parcel.PID.toString().substr(parcel.PID.toString().length - 4);
            },

            tripParcelsChanged: function(newVal, oldVal){
                //debugger;
            },
            toggleSelection: function(e) {
                var item = this.$.itemsList.itemForElement(e.target);
                this.$.selector.select(item);
            }
        });

    </script>
</dom-module>

