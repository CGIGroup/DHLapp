<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/sortable-list/sortable-list.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-time-input/paper-time-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="dhl-icons.html">

<dom-module id="dhl-tripprepare">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }

            .details{
                margin-bottom: 20px;
                cursor: pointer;
                outline: #cc0201;
                outline-style: solid;
                padding: 3px;
            }

            .leading {
                width: 30px;
            }
        </style>

        <div class="media">
            <div class="card">
                <h3>Rit Sorteren</h3>
                <paper-time-input label="Eerste Verwachte Aankomst" format="24"></paper-time-input>
                <paper-button on-tap="onSortSave" raised>Sortering Opslaan</paper-button>
            </div>
            <div class="card">
                <sortable-list>
                    <template is="dom-repeat"
                              items="{{resp301.xml-fragment.REPLY_OVERVIEW_PARCELS}}"
                              as="parcel"
                              filter="isOurTrip"
                              sort="sortBySeqNum"
                              observe="DELIVERY_SEQUENCE_NUMBER">
                        <div class="layout horizontal">
                            <div class="leading">[[parcel.DELIVERY_SEQUENCE_NUMBER]]</div>
                            <div class="details flex">
                                <div>[[parcel.CUSTOMER_SHORT_NAME]]</div>
                                <div>[[parcel.STREET]] [[parcel.HOUSE_NUMBER]]</div>
                                <div>[[parcel.POSTAL_CODE_NUMERIC]][[parcel.POSTAL_CODE_ALPHA]] [[parcel.CITY]]</div>
                            </div>
                            <div class="layout vertical">
                                <paper-icon-button on-tap="onUpTap" parcel="[[parcel]]" icon="dhl-icons:arrow-up"></paper-icon-button>
                                <paper-icon-button on-tap="onDownTap" parcel="[[parcel]]" icon="dhl-icons:arrow-down"></paper-icon-button>
                            </div>
                        </div>
                    </template>
                </sortable-list>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'dhl-tripprepare',


            properties: {

                selectedParcel:{
                    type: Object,
                    notify: true
                },

                resp301:{
                    type: Object
                },

                selectedTripId:{
                    type: String
                }
            },

            onSortSave: function(event) {
                window.history.back();
            },

            onUpTap: function(event) {
                var selectedParcel = event.target.parcel;

                var selectedParcelIdx = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS.findIndex(function(parcel){
                    if(parcel.PARCEL_KEY == selectedParcel.PARCEL_KEY) return true;
                }.bind(this));

                var otherSeq = parseInt(selectedParcel.DELIVERY_SEQUENCE_NUMBER) - 1;
                var otherParcelIdx = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS.findIndex(function(parcel){
                    return (this.selectedTripId == parcel.TRIP_KEY && parcel.DELIVERY_SEQUENCE_NUMBER == otherSeq);
                }.bind(this));

                //console.log('old', selectedParcelIdx, otherParcelIdx);
                if(otherParcelIdx >= 0){
                    var swap = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS[otherParcelIdx].DELIVERY_SEQUENCE_NUMBER;
                    this.set('resp301.xml-fragment.REPLY_OVERVIEW_PARCELS.'+otherParcelIdx+'.DELIVERY_SEQUENCE_NUMBER',
                            selectedParcel.DELIVERY_SEQUENCE_NUMBER);
                    this.set('resp301.xml-fragment.REPLY_OVERVIEW_PARCELS.'+selectedParcelIdx+'.DELIVERY_SEQUENCE_NUMBER',
                            swap);
                }
            },
            onDownTap: function(event) {
                var selectedParcel = event.target.parcel;

                var selectedParcelIdx = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS.findIndex(function(parcel){
                    if(parcel.PARCEL_KEY == selectedParcel.PARCEL_KEY) return true;
                }.bind(this));

                var otherSeq = parseInt(selectedParcel.DELIVERY_SEQUENCE_NUMBER) + 1;
                var otherParcelIdx = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS.findIndex(function(parcel){
                    return (this.selectedTripId == parcel.TRIP_KEY && parcel.DELIVERY_SEQUENCE_NUMBER == otherSeq);
                }.bind(this));

                //console.log('old', selectedParcelIdx, otherParcelIdx);
                if(otherParcelIdx >= 0){
                    var swap = this.resp301['xml-fragment'].REPLY_OVERVIEW_PARCELS[otherParcelIdx].DELIVERY_SEQUENCE_NUMBER;
                    this.set('resp301.xml-fragment.REPLY_OVERVIEW_PARCELS.'+otherParcelIdx+'.DELIVERY_SEQUENCE_NUMBER',
                            selectedParcel.DELIVERY_SEQUENCE_NUMBER);
                    this.set('resp301.xml-fragment.REPLY_OVERVIEW_PARCELS.'+selectedParcelIdx+'.DELIVERY_SEQUENCE_NUMBER',
                            swap);
                }
            },

            isOurTrip: function(parcel) {
                return this.selectedTripId == parcel.TRIP_KEY;
            },
            sortBySeqNum: function(v1, v2) {
                var val1 = parseInt(v1.DELIVERY_SEQUENCE_NUMBER), val2 = parseInt(v2.DELIVERY_SEQUENCE_NUMBER);
                if (val1 == val2) return 0;
                if (val1 > val2) return 1;
                if (val1 < val2) return -1;
            }
        });
    </script>
</dom-module>
