<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="dhl-xmlxhr">
    <template>

        <!-- text.xml sends prefilght, text/plain causes cors error error

                url="[[url]]"
                method="[[method]]"-->
        <iron-ajax
                id="ajax"
                method="POST"
                url="https://depotws-test.nl.dhl.com/SVDepotPDAWs"
                content-type="text/xml"
                handle-as="xml"
                on-response="handleResponse"
                on-error="handleError">
        </iron-ajax>

    </template>

    <script src="../bower_components/abdmob/x2js/xml2json.js"></script>

    <script>
        Polymer({
            is: 'dhl-xmlxhr',

            listeners: {
                'generateRequest': 'generateRequest'
            },

            properties:{

                /**
                 * The messageIdentifier to be used
                 */
                messageIdentifier:{
                    type: String,
                },

                /**
                 * The body to be sent, in JSON format
                 */
                body: {
                    type: Object,
                },

                /**
                 * The response from the server, in JSON format
                 */
                response:{
                    type: Object,
                    notify: true,
                },

                /**
                 * OK text for the toast, default is server response text
                 */
                okText:{
                    type: String
                },

                /**
                 * Error text for the toast, default is server response text
                 */
                errorText:{
                    type: String
                },

                /**
                 * The general header to be used on all future requests
                 */
                generalHeaderPda:{
                    type: Object,
                    notify: true
                },
            },

            generateRequest: function(){

                // update the general header
                this.generalHeaderPda.MESSAGE_TIMESTAMP = new Date().toJSON().toString();
                this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER =
                        parseInt(this.generalHeaderPda.MESSAGE_SEQUENCE_SESSION_NUMBER) + 1;
                this.generalHeaderPda.MESSAGE_IDENTIFIER= this.messageIdentifier;

                var operationName = Object.keys(this.body)[0];
                this.body[operationName].GENERAL_HEADER_PDA = this.generalHeaderPda;

                var prefixedFragment = this.addNameSpace(this.body);

                var envelope = {
                    'soapenv:Envelope':{
                        '_xmlns:soapenv': "http://schemas.xmlsoap.org/soap/envelope/",
                        '_xmlns:svd': "http://selektvracht.nl/SVDepotPDAWs",
                        'soapenv:Header': null,
                        'soapenv:Body': prefixedFragment
                    }
                };

                var parser = new X2JS();
                var xmlBody = parser.json2xml_str(envelope);
                this.$.ajax.body = xmlBody;
                console.log(xmlBody);
                this.$.ajax.generateRequest();
            },

            addNameSpace: function(origFrag){
                var newFrag = {};
                for(var key in origFrag){
                    var value = origFrag[key];
                    if(typeof(value) === 'object'){
                        newFrag['svd:'+key] = this.addNameSpace(value)
                    }
                    else newFrag['svd:'+key] = value;
                }
                return newFrag;
            },

            handleResponse: function(event){
                var responseXml = event.detail.xhr.response;
                var parser = new X2JS();
                this.response = parser.xml_str2json(responseXml);

                console.log(this.response);

                //show result in toast
                var toast = document.getElementById('toastOk');
                toast.text = this.okText?this.okText:event.detail.request.xhr.response.message;
                toast.open();
            },

            handleError: function(event){
                //show result in toast
                var toast = document.getElementById('toastError');
                var message = this.errorText?this.errorText:event.detail.request.xhr.response.message;
                toast.text = event.detail.request.xhr.status+' '+message;
                toast.open();
            }
        });
    </script>
</dom-module>
